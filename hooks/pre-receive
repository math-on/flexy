#!/bin/bash

/config-parser.rb

set -a
. /set_env_vars.sh
set +a

cp -r /buildpack .
docker build -t $APPLICATION_NAME .
TAG_HASH=`< /dev/urandom tr -dc a-z-0-9 | head -c10`
APPLICATION_TAG=gcr.io/$PROJECT_ID/$APPLICATION_NAME:$TAG_HASH
LATEST_TAG=gcr.io/$PROJECT_ID/$APPLICATION_NAME:latest

docker tag $APPLICATION_NAME $APPLICATION_TAG
docker tag $APPLICATION_NAME $LATEST_TAG
docker login -u _json_key -p "$CONTAINER_REGISTRY_SA" https://gcr.io
docker push $APPLICATION_TAG
docker push $LATEST_TAG
/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file /gke_sa.json --project $PROJECT_ID
/google-cloud-sdk/bin/gcloud container clusters get-credentials $CLUSTER --zone $ZONE
kubectl set image deployment $APPLICATION_NAME $APPLICATION_NAME=$APPLICATION_TAG
